name: EvaluaciÃ³n AutomÃ¡tica

on:
  push:
    paths:
      - 'Ejercicio.cpp'
      - 'tests/**'
    branches:
      - main

permissions:
  contents: write

jobs:
  build-and-test:
    name: ðŸš€ EvaluaciÃ³n AutomÃ¡tica
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ›Žï¸ Clonar el repositorio
        uses: actions/checkout@v3

      - name: ðŸ› ï¸ Instalar Dependencias
        run: |
          sudo apt update && sudo apt install -y g++
          git clone https://github.com/google/googletest.git
          mkdir googletest/build
          cd googletest/build
          cmake ..
          make
          sudo make install

      - name: ðŸ› ï¸ Compilar cÃ³digo del estudiante
        run: g++ -std=c++20 -DTEST_MODE -c Ejercicio.cpp -o Ejercicio.o

      - name: ðŸ› ï¸ Compilar pruebas con Google Test
        run: |
          for file in tests/*.cpp; do
            g++ -std=c++20 -c $file -o ${file%.cpp}.o -I/usr/local/include -pthread
          done

      - name: ðŸ”— Enlazar cÃ³digo y pruebas
        run: g++ -o test Ejercicio.o tests/*.o -lgtest -lgtest_main -pthread

      - name: ðŸš€ Ejecutar pruebas con Google Test y capturar salida
        run: |
          ./test > test_output.log || true
          cat test_output.log  # Mostrar la salida para depuraciÃ³n

      - name: ðŸ“Š Analizar resultados y calcular nota
        id: calcular_calificacion
        run: |
          TOTAL_TESTS=$(grep -c "\[ RUN      \]" test_output.log || echo 0)
          PASSED_TESTS=$(grep -c "\[       OK \]" test_output.log || echo 0)
          FAILED_TESTS=$(grep -c "\[  FAILED  \]" test_output.log || echo 0)

          if [ "$TOTAL_TESTS" -eq 0 ]; then
            SCORE=0
          else
            SCORE=$((10 * PASSED_TESTS / TOTAL_TESTS))
          fi

          echo "GRADE=$SCORE/10" >> $GITHUB_ENV
          echo "GRADE=$SCORE/10" >> $GITHUB_OUTPUT

          echo "ðŸ“Š CalificaciÃ³n automÃ¡tica: $SCORE/10" > test_summary.txt
          echo "--------------------------------------" >> test_summary.txt
          echo "Total de pruebas: $TOTAL_TESTS" >> test_summary.txt
          echo "Pruebas aprobadas: $PASSED_TESTS" >> test_summary.txt
          echo "Pruebas fallidas: $FAILED_TESTS" >> test_summary.txt
          echo "Nota final: $SCORE/10" >> test_summary.txt
          echo "" >> test_summary.txt

          echo "ðŸ“ Autograding Reporter" >> test_summary.txt
          echo "----------------------------" >> test_summary.txt
          grep "\[       OK \]" test_output.log | awk '{print "| " $3 " | 1 | 1 |"}' >> test_summary.txt
          echo "----------------------------" >> test_summary.txt
          echo "| Total: | $SCORE | 10 |" >> test_summary.txt
          echo "----------------------------" >> test_summary.txt
          echo "ðŸ† Grand total tests passed: $PASSED_TESTS/$TOTAL_TESTS" >> test_summary.txt

      - name: ðŸ“¢ Reportar calificaciÃ³n en GitHub Actions
        run: |
          echo "::notice title=CalificaciÃ³n::$SCORE/10"
          echo "::notice title=Autograding Report::{\"totalPoints\":$SCORE,\"maxPoints\":10}"
          if [ "$SCORE" -lt 6 ]; then
            echo "::error title=CalificaciÃ³n Insuficiente::El estudiante obtuvo una calificaciÃ³n de $SCORE/10."
          fi

      - name: ðŸ’¾ Guardar resultados de pruebas
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test_output.log
            test_summary.txt

      - name: ðŸ“Œ Publicar resumen en Actions
        run: |
          echo "# ðŸ“Š Resumen de EvaluaciÃ³n" >> $GITHUB_STEP_SUMMARY
          cat test_summary.txt >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“œ Exportar calificaciÃ³n para GitHub Classroom
        run: |
          echo "{\"tests\":[{\"name\":\"Total\",\"score\":$SCORE,\"max_score\":10}]}" > .github/classroom/autograding.json
