
  name: EvaluaciÃ³n AutomÃ¡tica
  
  on:
    push:
      paths:
        - 'Ejercicio.cpp'
        - 'tests/**'
      branches:
        - main
  
  permissions:
    contents: write
  
  jobs:
    build-and-test:
      name: ğŸš€ EvaluaciÃ³n AutomÃ¡tica
      runs-on: ubuntu-latest
  
      steps:
        - name: ğŸ›ï¸ Clonar el repositorio
          uses: actions/checkout@v3
  
        - name: ğŸ› ï¸ Instalar Dependencias
          run: |
            sudo apt update && sudo apt install -y g++
            git clone https://github.com/google/googletest.git
            mkdir googletest/build
            cd googletest/build
            cmake ..
            make
            sudo make install
  
        - name: ğŸ› ï¸ Compilar cÃ³digo del estudiante
          run: g++ -std=c++20 -DTEST_MODE -c Ejercicio.cpp -o Ejercicio.o
  
        - name: ğŸ› ï¸ Compilar pruebas con Google Test
          run: |
            for file in tests/*.cpp; do
             g++ -std=c++20 -c $file -o ${file%.cpp}.o -I/usr/local/include -pthread
            done
  
        - name: ğŸ”— Enlazar cÃ³digo y pruebas
          run: g++ -o test Ejercicio.o tests/*.o -lgtest -lgtest_main -pthread
  
        - name: ğŸš€ Ejecutar pruebas con Google Test y capturar salida
          run: |
            ./test > test_output.log || true
            cat test_output.log  # Mostrar la salida para depuraciÃ³n
            
        - name: ğŸ“Š Analizar resultados y calcular nota
          id: calcular_calificacion
          run: |
            TOTAL_TESTS=$(grep -c "\[ RUN      \]" test_output.log || echo 0)
            PASSED_TESTS=$(grep -c "\[       OK \]" test_output.log || echo 0)
            FAILED_TESTS=$(grep -c "\[  FAILED  \]" test_output.log || echo 0)
  
            if [ "$TOTAL_TESTS" -eq 0 ]; then
              SCORE=0
            else
              SCORE=$((100 * PASSED_TESTS / TOTAL_TESTS))
            fi
  
            echo "ğŸ“Š CalificaciÃ³n automÃ¡tica: $SCORE/100" > test_summary.txt
            echo "--------------------------------------" >> test_summary.txt
            echo "Total de pruebas: $TOTAL_TESTS" >> test_summary.txt
            echo "Pruebas aprobadas: $PASSED_TESTS" >> test_summary.txt
            echo "Pruebas fallidas: $FAILED_TESTS" >> test_summary.txt
            echo "Nota final: $SCORE/100" >> test_summary.txt
            echo "" >> test_summary.txt
  
            echo "âœ… Pruebas aprobadas:" >> test_summary.txt
            grep "\[       OK \]" test_output.log | sed -E 's/.*\] (.*) \(.*/- \1/' >> test_summary.txt || echo "- Ninguna" >> test_summary.txt
  
            echo "" >> test_summary.txt
            echo "âŒ Pruebas fallidas:" >> test_summary.txt
            grep "\[  FAILED  \]" test_output.log | sed -E 's/.*\] (.*) \(.*/- \1/' >> test_summary.txt || echo "- Ninguna" >> test_summary.txt
  
            echo "SCORE=$SCORE" >> $GITHUB_ENV
            echo "SCORE=$SCORE" >> $GITHUB_OUTPUT
  
        - name: ğŸ’¾ Guardar resultados de pruebas
          uses: actions/upload-artifact@v4
          with:
            name: test-results
            path: |
              test_output.log
              test_summary.txt
  
        - name: ğŸ“Œ Guardar la calificaciÃ³n en una rama protegida
          run: |
            git config --global user.name "GitHub Bot"
            git config --global user.email "bot@github.com"
            git fetch origin calificaciones || true
            git checkout -B calificaciones origin/calificaciones || git checkout -b calificaciones
  
            SCORE=$SCORE
            PASSED_TESTS=$(grep -c "\[       OK \]" test_output.log || echo 0)
            FAILED_TESTS=$(grep -c "\[  FAILED  \]" test_output.log || echo 0)
  
            echo "ğŸ“Š CalificaciÃ³n automÃ¡tica: $SCORE/100" > calificacion.txt
            echo "--------------------------------------" >> calificacion.txt
            cat test_summary.txt >> calificacion.txt  # Agregar el resumen de pruebas
  
            git add calificacion.txt
            git commit -m "ğŸ“Š CalificaciÃ³n: $SCORE/100 | âœ… Aprobadas: $PASSED_TESTS | âŒ Fallidas: $FAILED_TESTS"
            git push origin calificaciones --force
  
